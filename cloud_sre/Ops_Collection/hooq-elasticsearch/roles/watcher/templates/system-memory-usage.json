  {
    "metadata": {
      "name": "{{ svc }}-system-memory-usage-watcher",
      "threshold": {{ memory_threshold | float }},
      "window_period": "{{ window_period }}"
    },  
    "trigger": {
      "schedule": {
        "interval": "{{ window_period }}"
      }
    },
    "input": {
      "search": {
        "request": {
          "body": {
            "query": {
              "bool": {
                "filter":[
                  {
                      "range": {
                        "@timestamp": {
                          "lte": "now-{% raw %}{{ctx.metadata.window_period}}{% endraw %}",
                          "format": "strict_date_optional_time||epoch_millis"
                        }
                        
                      }
                  },
                  {
                      "match": {
                        "fields.env": "prod"
                      }
                  }
                ] 
              }
            },
            "aggs": {
              "metricAgg": {
                "avg": {
                  "field":  "system.memory.actual.used.pct"
                }
              }
            }
          },
          "indices": [
            "hooq-metricbeat-{{ svc }}-*"
          ]
        }
      }
    },
    "condition": {
      "script": {
        "source": "if (ctx.payload.aggregations.metricAgg.value >= ctx.metadata.threshold) { return true; } return false;"
      }
    },
    "transform" : {
      
        "script": " def threshold_p = ctx.metadata.threshold*100; return [ 'actual_value': (int)ctx.payload.aggregations.metricAgg.value*100 , 'threshold': (int)threshold_p * 100 ] "
      
    },
    "actions": {
      "slack_channel": {
        "slack": {
          "message": {
            "to": [
              {{ slack_channel }}
            ],
            "text": "You are receiving this notification because your {% raw %}{{ctx.metadata.name}}{% endraw %} has entered alarm state because the actual average percentage for the metric {% raw %}{{ctx.payload.actual_value}}{% endraw %}%, has crossed the average threshold {% raw %}{{ctx.payload.threshold}}{% endraw %}% "
          }
        }
      }
      
    }
  }
