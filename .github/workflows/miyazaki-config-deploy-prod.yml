name: miyazaki-config-prod-pipeline
on:  
  push:
    tags:
      - miyazaki-config-prod-*
jobs:
 miyazaki-config-prod-job:
    runs-on: ubuntu-latest
    steps:


      - name: Checkout public repo
        uses: actions/checkout@master

      - name: Install botocore and boto3
        run: pip install botocore boto3

      - name: Get the latest terraform version
        run: make terraform-install
        env:
          TF_VERSION: ${{ secrets.TF_STABLE_VERSION }}

      - name: Apply terraform miyazaki config
        run: make terraform-apply
        working-directory: services/miyazaki/config-deploy/
        env:
          TF_IN_AUTOMATION: true
          TF_WORKSPACE: prod
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PROD_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PROD_SECRET_KEY }}
          TF_TOKEN_MIYAZAKI: ${{ secrets.TF_TOKEN_MIYAZAKI }}

      - name: Configs for miyazaki secrets
        run: make ansible-apply
        working-directory: services/miyazaki/config-deploy/
        env:
          ANSIBLE_VAULT_PASSWORD_FILE: vault_env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.MIYAZAKI_ANSIBLE_VAULT_PASSWORD }}
          ENVIRONMENT: prod
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PROD_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PROD_SECRET_KEY }}
          AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
