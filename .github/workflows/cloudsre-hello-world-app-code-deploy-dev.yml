name: cloudsre-hello-world-app-code-deploy-dev
on:
  pull_request:
    types: [closed]
    paths:
      - "services/cloudsre-hello-world-app/code-deploy/**"

jobs:
  cloudsre-hello-world-app-image-build-job-dev:
    runs-on: ubuntu-latest
    steps:
      - name: checkout public repo
        if: github.event.pull_request.merged == true
        uses: actions/checkout@v1.2.0

      - name: get github context
        run: echo ${{ toJson(github) }}


      - name: push image to our Private Hub
        run: |
          export BRANCH_TAG=${BRANCH_COMMIT_ID##*/}
          export MASTER_TAG=`sed -e 's/^"//' -e 's/"$//' <<<"$MASTER_COMMIT_ID" | cut -c1-7 `
          make docker-retag-push
        working-directory: services/cloudsre-hello-world-app/code-deploy/src/
        env:
          DOCKER_TOKEN: ${{ secrets.QUAY_REGISTRY_TOKEN }}
          SSH_KEY: ${{ secrets.DEPLOYER_KEY_PRIV }}
          SSH_KEY_PUB: ${{ secrets.DEPLOYER_KEY_PUB }}
          MASTER_COMMIT_ID: ${{ toJson(github.event.pull_request.merge_commit_sha) }}
          BRANCH_COMMIT_ID: ${{ toJson(github.head_ref) }}

  cloudsre-hello-world-app-ecs-deployment-dev:
    runs-on: ubuntu-latest
    needs: cloudsre-hello-world-app-image-build-job-dev
    steps:
      - name: checkout public repo
        uses: actions/checkout@master

      - name: Get the latest terraform version
        run: make terraform-install
        env:
          TF_VERSION: ${{ secrets.TF_STABLE_VERSION }}

      - name: cloudsre-hello-world-app apply terraform
        run: |
          export APP_TAG=`sed -e 's/^"//' -e 's/"$//' <<<"$MASTER_COMMIT_ID" | cut -c1-7 ` && sed -i -e "s/APP_TAG/$APP_TAG/g" *.tf
          make terraform-apply
        working-directory: services/cloudsre-hello-world-app/code-deploy/
        env:
          TF_IN_AUTOMATION: true
          TF_WORKSPACE: dev
          TF_TOKEN_CLOUD_SRE: ${{ secrets.TF_TOKEN_CLOUD_SRE }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_DEV_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_DEV_SECRET_KEY }}
          BRANCH_COMMIT_ID: ${{ toJson(github.head_ref) }}
